name: ğŸ”„ Manual Deployment & Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - deploy
          - rollback
          - restart
          - migrate
          - seed
      version:
        description: 'Version to deploy (leave empty for latest)'
        required: false
        type: string
      rollback_version:
        description: 'Version to rollback to (required for rollback)'
        required: false
        type: string
      force:
        description: 'Force action (skip confirmations)'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # =========================================
  # JOB 1: Validate Input
  # =========================================
  validate:
    name: âœ… Validate Request
    runs-on: ubuntu-latest

    outputs:
      target-version: ${{ steps.version.outputs.version }}
      environment: ${{ github.event.inputs.environment }}
      action: ${{ github.event.inputs.action }}

    steps:
      - name: ğŸ“‹ Display request details
        run: |
          echo "ğŸ¯ Deployment Request Details:"
          echo "================================"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Action: ${{ github.event.inputs.action }}"
          echo "Version: ${{ github.event.inputs.version || 'latest' }}"
          echo "Rollback Version: ${{ github.event.inputs.rollback_version || 'N/A' }}"
          echo "Force: ${{ github.event.inputs.force }}"
          echo "Requested by: ${{ github.actor }}"
          echo "================================"

      - name: ğŸ” Validate rollback requirements
        if: github.event.inputs.action == 'rollback'
        run: |
          if [[ -z "${{ github.event.inputs.rollback_version }}" ]]; then
            echo "âŒ Rollback version is required for rollback action"
            exit 1
          fi
          echo "âœ… Rollback validation passed"

      - name: ğŸ·ï¸ Determine target version
        id: version
        run: |
          if [[ "${{ github.event.inputs.action }}" == "rollback" ]]; then
            VERSION="${{ github.event.inputs.rollback_version }}"
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="latest"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ¯ Target version: $VERSION"

      - name: âš ï¸ Production safety check
        if: github.event.inputs.environment == 'production' && github.event.inputs.force == 'false'
        run: |
          echo "âš ï¸ PRODUCTION DEPLOYMENT WARNING"
          echo "================================"
          echo "You are about to perform: ${{ github.event.inputs.action }}"
          echo "Environment: PRODUCTION"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo ""
          echo "This action will affect the live production environment!"
          echo "Make sure you have:"
          echo "âœ… Tested in staging environment"
          echo "âœ… Verified database migrations"
          echo "âœ… Notified the team"
          echo "âœ… Have a rollback plan ready"
          echo ""
          echo "Proceeding in 10 seconds... (Cancel now if not ready)"
          sleep 10

  # =========================================
  # JOB 2: Pre-deployment Health Check
  # =========================================
  health-check:
    name: ğŸ¥ Pre-deployment Health Check
    runs-on: ubuntu-latest
    needs: validate
    if: contains(fromJson('["deploy", "rollback"]'), github.event.inputs.action)

    steps:
      - name: ğŸ” Check current environment status
        run: |
          ENV="${{ needs.validate.outputs.environment }}"
          
          if [[ "$ENV" == "staging" ]]; then
            URL="https://api-staging.pavillon-les-lys.fr"
          else
            URL="https://api.pavillon-les-lys.fr"
          fi
          
          echo "ğŸ” Checking current status of $ENV environment..."
          
          # Check if API is responding
          if curl -f "$URL/health" > /dev/null 2>&1; then
            echo "âœ… Environment is currently healthy"
            
            # Get current version info if possible
            CURRENT_VERSION=$(curl -s "$URL/health" | jq -r '.version // "unknown"' 2>/dev/null || echo "unknown")
            echo "ğŸ“‹ Current version: $CURRENT_VERSION"
          else
            echo "âš ï¸ Environment appears to be down or unhealthy"
            echo "This deployment might be fixing an outage"
          fi

  # =========================================
  # JOB 3: Execute Deployment Action
  # =========================================
  execute-action:
    name: ğŸš€ Execute ${{ github.event.inputs.action }}
    runs-on: ubuntu-latest
    needs: [validate, health-check]
    environment: 
      name: ${{ github.event.inputs.environment }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ github.event.inputs.environment == 'production' && secrets.PRODUCTION_SSH_PRIVATE_KEY || secrets.STAGING_SSH_PRIVATE_KEY }}

      - name: ğŸ¯ Set environment variables
        run: |
          ENV="${{ github.event.inputs.environment }}"
          if [[ "$ENV" == "staging" ]]; then
            echo "SSH_HOST=${{ secrets.STAGING_HOST }}" >> $GITHUB_ENV
            echo "SSH_USER=${{ secrets.STAGING_USER }}" >> $GITHUB_ENV
            echo "APP_URL=https://api-staging.pavillon-les-lys.fr" >> $GITHUB_ENV
          else
            echo "SSH_HOST=${{ secrets.PRODUCTION_HOST }}" >> $GITHUB_ENV
            echo "SSH_USER=${{ secrets.PRODUCTION_USER }}" >> $GITHUB_ENV
            echo "APP_URL=https://api.pavillon-les-lys.fr" >> $GITHUB_ENV
          fi

      # Deploy Action
      - name: ğŸš€ Deploy to ${{ github.event.inputs.environment }}
        if: github.event.inputs.action == 'deploy'
        run: |
          VERSION="${{ needs.validate.outputs.target-version }}"
          echo "ğŸš€ Deploying version $VERSION to ${{ github.event.inputs.environment }}"
          
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
            set -e
            cd /opt/pavillon-les-lys-api
            
            echo "ğŸ“‹ Current status:"
            docker-compose ps
            
            echo "ğŸ’¾ Creating backup..."
            BACKUP_TAG="backup-\$(date +%Y%m%d-%H%M%S)"
            docker tag \$(docker-compose images -q api 2>/dev/null || echo "none") pavillon-les-lys:\$BACKUP_TAG 2>/dev/null || true
            
            echo "ğŸ“¥ Pulling new image..."
            if [[ "$VERSION" == "latest" ]]; then
              docker-compose pull api
            else
              sed -i "s|image: .*pavillon-les-lys.*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION|" docker-compose.yml
              docker-compose pull api
            fi
            
            echo "ğŸ”„ Restarting services..."
            docker-compose up -d api
            
            echo "â³ Waiting for service to be ready..."
            sleep 15
            
            echo "âœ… Deployment completed"
          EOF

      # Rollback Action
      - name: ğŸ”„ Rollback to ${{ github.event.inputs.rollback_version }}
        if: github.event.inputs.action == 'rollback'
        run: |
          ROLLBACK_VERSION="${{ github.event.inputs.rollback_version }}"
          echo "ğŸ”„ Rolling back to version $ROLLBACK_VERSION"
          
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
            set -e
            cd /opt/pavillon-les-lys-api
            
            echo "ğŸ“‹ Current status:"
            docker-compose ps
            
            echo "ğŸ”„ Rolling back to $ROLLBACK_VERSION..."
            sed -i "s|image: .*pavillon-les-lys.*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$ROLLBACK_VERSION|" docker-compose.yml
            
            docker-compose pull api
            docker-compose up -d api
            
            echo "â³ Waiting for service to be ready..."
            sleep 15
            
            echo "âœ… Rollback completed"
          EOF

      # Restart Action
      - name: ğŸ”„ Restart services
        if: github.event.inputs.action == 'restart'
        run: |
          echo "ğŸ”„ Restarting services in ${{ github.event.inputs.environment }}"
          
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
            set -e
            cd /opt/pavillon-les-lys-api
            
            echo "ğŸ“‹ Current status:"
            docker-compose ps
            
            echo "ğŸ”„ Restarting all services..."
            docker-compose restart
            
            echo "â³ Waiting for services to be ready..."
            sleep 20
            
            echo "âœ… Restart completed"
          EOF

      # Migrate Action
      - name: ğŸ—„ï¸ Run database migrations
        if: github.event.inputs.action == 'migrate'
        run: |
          echo "ğŸ—„ï¸ Running database migrations in ${{ github.event.inputs.environment }}"
          
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
            set -e
            cd /opt/pavillon-les-lys-api
            
            echo "ğŸ—„ï¸ Running Prisma migrations..."
            docker-compose exec -T api yarn prisma migrate deploy
            
            echo "ğŸ”„ Generating Prisma client..."
            docker-compose exec -T api yarn prisma generate
            
            echo "âœ… Migrations completed"
          EOF

      # Seed Action
      - name: ğŸŒ± Seed database
        if: github.event.inputs.action == 'seed'
        run: |
          echo "ğŸŒ± Seeding database in ${{ github.event.inputs.environment }}"
          
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
            set -e
            cd /opt/pavillon-les-lys-api
            
            echo "âš ï¸ Warning: This will seed the database with test data"
            echo "ğŸŒ± Running database seed..."
            docker-compose exec -T api yarn db:seed
            
            echo "âœ… Database seeding completed"
          EOF

  # =========================================
  # JOB 4: Post-deployment Verification
  # =========================================
  verify:
    name: âœ… Post-deployment Verification
    runs-on: ubuntu-latest
    needs: [validate, execute-action]
    if: contains(fromJson('["deploy", "rollback", "restart"]'), github.event.inputs.action)

    steps:
      - name: ğŸ¥ Health check
        run: |
          ENV="${{ github.event.inputs.environment }}"
          
          if [[ "$ENV" == "staging" ]]; then
            URL="https://api-staging.pavillon-les-lys.fr"
          else
            URL="https://api.pavillon-les-lys.fr"
          fi
          
          echo "ğŸ¥ Running health checks..."
          
          # Wait a bit for the service to fully start
          sleep 30
          
          # Check health endpoint
          if curl -f "$URL/health"; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
            exit 1
          fi
          
          # Check authentication endpoint
          if curl -f "$URL/auth/login" -X POST -H "Content-Type: application/json" -d '{}' | grep -q "email"; then
            echo "âœ… Authentication endpoint responding"
          else
            echo "âš ï¸ Authentication endpoint may have issues"
          fi

      - name: ğŸ“Š Service status
        run: |
          echo "ğŸ“Š Final service status:"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Action: ${{ github.event.inputs.action }}"
          echo "Version: ${{ needs.validate.outputs.target-version }}"
          echo "Status: âœ… Completed successfully"

  # =========================================
  # JOB 5: Notifications
  # =========================================
  notify:
    name: ğŸ“¢ Send Notifications
    runs-on: ubuntu-latest
    needs: [validate, execute-action, verify]
    if: always()

    steps:
      - name: ğŸ’¬ Slack notification
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: custom
          custom_payload: |
            {
              "text": "${{ needs.verify.result == 'success' && 'âœ…' || 'âŒ' }} Manual Deployment: ${{ github.event.inputs.action }}",
              "attachments": [
                {
                  "color": "${{ needs.verify.result == 'success' && 'good' || 'danger' }}",
                  "fields": [
                    {
                      "title": "Environment",
                      "value": "${{ github.event.inputs.environment }}",
                      "short": true
                    },
                    {
                      "title": "Action",
                      "value": "${{ github.event.inputs.action }}",
                      "short": true
                    },
                    {
                      "title": "Version",
                      "value": "${{ needs.validate.outputs.target-version }}",
                      "short": true
                    },
                    {
                      "title": "Triggered by",
                      "value": "${{ github.actor }}",
                      "short": true
                    },
                    {
                      "title": "Status",
                      "value": "${{ needs.verify.result == 'success' && 'Success' || 'Failed' }}",
                      "short": false
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ“§ Email notification
        if: github.event.inputs.environment == 'production'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "${{ needs.verify.result == 'success' && 'âœ…' || 'âŒ' }} Production ${{ github.event.inputs.action }} - Pavillon Les Lys API"
          to: ${{ secrets.PRODUCTION_NOTIFICATION_EMAIL }}
          from: "GitHub Actions <ops@pavillon-les-lys.fr>"
          body: |
            Manual deployment action completed for Pavillon Les Lys API
            
            Environment: ${{ github.event.inputs.environment }}
            Action: ${{ github.event.inputs.action }}
            Version: ${{ needs.validate.outputs.target-version }}
            Status: ${{ needs.verify.result == 'success' && 'Success' || 'Failed' }}
            Triggered by: ${{ github.actor }}
            
            Timestamp: ${{ github.event.head_commit.timestamp }}
            
            View workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
